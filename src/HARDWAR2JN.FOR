
      SUBROUTINE RUN_WPLOT(CEELINE)
C     THIS IS THE DRIVER ROUTINE FOR SENDING GRAPHICS TO
C     HARDCOPY DEVICES
C      USE WINTERACTER
      IMPLICIT NONE
      CHARACTER CEELINE*(*)
      INCLUDE 'DATMAI.INC'
      PRINT *, "RUN_WPLOT CEELINE = ", CEELINE
      CALL WPLOT(CEELINE)
      RETURN
      END
      SUBROUTINE WPLOT(CEELINE)
C     PLOTTING ROUTINE FOR HARDCOPY
C      USE WINTERACTER
      IMPLICIT NONE
      LOGICAL OPEN28,EXIS28
      CHARACTER CEELINE*(*),FILNAME*12
      INTEGER NCOL256,I,ID
      INCLUDE 'DATMAI.INC'
                        DO I=1,10
      IF(CEELINE(1:1).EQ.' ') CEELINE(1:80)=CEELINE(2:80)//' '
                        END DO
      FILNAME(1:12)=CEELINE(3:14)
       EXIS28=.FALSE.
       OPEN28=.FALSE.
       INQUIRE(FILE='NEUTRAL.DAT',EXIST=EXIS28)
       INQUIRE(FILE='NEUTRAL.DAT',OPENED=OPEN28)
       IF(OPEN28) CALL CLOSE_FILE(28,1)
       IF(EXIS28) THEN
       PRINT *, "Calling WINTER Settings.."
C       CALL IGRPALETTERGB(223,0,0,0)
C       CALL IGRPALETTERGB(0,255,255,255)
C       CALL IGrColourN(223)
C       CALL IGRAREA(0.0,0.0,1.0,1.0)
C       CALL IGRUNITS(0.0,0.0,10000.0,7000.0)
C       CALL IGrViewport(-510.0,-510.0,10510.0,7510.0)
       IF(CEELINE(1:2).EQ.'01') CALL GRAOUTPRT(1,FILNAME)
       IF(CEELINE(1:2).EQ.'02') CALL GRAOUTPRT(2,FILNAME)
       IF(CEELINE(1:2).EQ.'03') CALL GRAOUTPRT(3,FILNAME)
       IF(CEELINE(1:2).EQ.'13') CALL GRAOUTPRT(13,FILNAME)
       IF(CEELINE(1:2).EQ.'23') CALL GRAOUTPRT(23,FILNAME)
       IF(CEELINE(1:2).EQ.'04') CALL GRAOUTPRT(4,FILNAME)
       IF(CEELINE(1:2).EQ.'34') CALL GRAOUTPRT(34,FILNAME)
       IF(CEELINE(1:2).EQ.'14') CALL GRAOUTPRT(14,FILNAME)
       IF(CEELINE(1:2).EQ.'24') CALL GRAOUTPRT(24,FILNAME)
       IF(CEELINE(1:2).EQ.'05') CALL GRAOUTPRT(5,FILNAME)
       IF(CEELINE(1:2).EQ.'15') CALL GRAOUTPRT(15,FILNAME)
       IF(CEELINE(1:2).EQ.'06') CALL GRAOUTPRT(6,FILNAME)
       IF(CEELINE(1:2).EQ.'07') CALL GRAOUTPRT(7,FILNAME)
       IF(CEELINE(1:2).EQ.'08') CALL GRAOUTPRT(8,FILNAME)
       IF(CEELINE(1:2).EQ.'09') CALL GRAOUTPRT(9,FILNAME)
       IF(CEELINE(1:2).EQ.'18') CALL GRAOUTPRT(18,FILNAME)
       IF(CEELINE(1:2).EQ.'19') CALL GRAOUTPRT(19,FILNAME)
       IF(CEELINE(1:2).EQ.'31') CALL GRAOUTPRT(31,FILNAME)
       IF(CEELINE(1:2).EQ.'32') CALL GRAOUTPRT(32,FILNAME)
       CALL CLOSE_FILE(28,1)
                        RETURN
                        ELSE
                        END IF
                        RETURN
                        END
      SUBROUTINE GRAOUTPRT(JK_TAG,GRFILN)
C     CALL BY HARDCOPY GRAPHICS ROUTINE
      USE GLOBALS
      use global_widgets
      use handlers
C      USE WINTERACTER
      use RCImageBasic
      use RCImageIO
      use RCImagePrimitive
      IMPLICIT NONE

      REAL MINII1, MINII2, MAXII1, MAXII2

      type(rgbimage) :: animage
      type(rgb) :: color






      REAL OPDPEAK,OPDPIT
      CHARACTER AB*80,STRINGER*1,C1A*20,C1B*20,C1C*20,C1D*20,GRFILN*12
      CHARACTER NEUTLINE*80
      CHARACTER C1*80
      CHARACTER CC1*1
      CHARACTER CC2*2
      CHARACTER CC3*3
      CHARACTER CC4*4
      CHARACTER CC5*5
      CHARACTER CC6*6
      CHARACTER CC7*7
      CHARACTER CC8*8
      CHARACTER CC9*9
      CHARACTER CC10*10
      CHARACTER CC11*11
      CHARACTER CC12*12
      CHARACTER CC13*13
      CHARACTER CC14*14
      CHARACTER CC15*15
      CHARACTER CC16*16
      CHARACTER CC17*17
      CHARACTER CC18*18
      CHARACTER CC19*19
      CHARACTER CC20*20
      CHARACTER CC21*21
      CHARACTER CC22*22
      CHARACTER CC23*23
      CHARACTER CC24*24
      CHARACTER CC25*25
      CHARACTER CC26*26
      CHARACTER CC27*27
      CHARACTER CC28*28
      CHARACTER CC29*29
      CHARACTER CC30*30
      CHARACTER CC31*31
      CHARACTER CC32*32
      CHARACTER CC33*33
      CHARACTER CC34*34
      CHARACTER CC35*35
      CHARACTER CC36*36
      CHARACTER CC37*37
      CHARACTER CC38*38
      CHARACTER CC39*39
      CHARACTER CC40*40
      INTEGER II,JJ,CON_ARRAY,NX,NY,ZSTEP,ALLOERR
      DIMENSION CON_ARRAY(:,:)
      ALLOCATABLE :: CON_ARRAY
      INTEGER COLPASS,COLTRUE,CHARSTYPE,JK_TAG
      INTEGER J,JIMLEN,I,IA1,IA2,IA3,IA4,ITRY
      INTEGER I1,I2,I3,I4,I5,I6,I7,I8
      INTEGER II1,II2,II3,II4,II5,II6,II7,II8
      REAL IA,IB,RRR1,RRR2
      COMMON/TEXTCOM/CHARSTYPE
      COMMON/COLCOM/COLPASS,COLTRUE
      REAL JJ_X,JJ_Y
      COMMON/ASPECTER/JJ_X,JJ_Y
      INTEGER PENPOSX,PENPOSY,NEUTTOTAL
      COMMON/TOTALNEUT/NEUTTOTAL
      COMMON/PENPEN2/PENPOSX,PENPOSY
      INCLUDE 'DATMAI.INC'

      call alloc_img(animage, 7400, 5652)
      call fill_img(animage, rgb(255,255,255))
C     INITIALIZE CHARACTER ASPECT RATIO
      JJ_X=1.0
      JJ_Y=1.0
      ITRY=0

      color = rgb(0,0,0)
      COLTRUE = 0
C
      PRINT *, "GRAOUT PRT ROUTINE"
      MINII1 = -1
      MINII2 = -1
                   J=1
      READ(NEUTARRAY(J),1000) NEUTTOTAL
 1000 FORMAT(I9,32X)
 300               J=J+1
      IF(J.GE.NEUTTOTAL+1) GO TO 999
      READ(NEUTARRAY(J),1001) STRINGER
     1,I1,I2,I3,I4,I5,I6,I7,I8
      !PRINT *, "STRINGER = ", STRINGER
 1001 FORMAT(A1,I5,I5,I5,I5,I5,I5,I5,I5)
      II1=(I1)
      II2=(I2)
      II3=(I3)
      II4=(I4)
      II5=(I5)
      II6=(I6)
      II7=(I7)
      II8=(I8)
C
C     "PLOT NEW" STRINGER = 'A'
C
C      PRINT *, "STRINGER = ",STRINGER

      IF(STRINGER.EQ.'A') THEN
      IF(JK_TAG.EQ.1.OR.JK_TAG.EQ.2) THEN
      PRINT *, "WINTER INIT"
C     INITIALIZE THE WINDOWS PRINT MANAGER (B&W OR COLOR)
C      CALL IGrHardCopySelect(1,10)
C      CALL IGrHardCopyOptions(1,720)
C      CALL IGrHardCopyOptions(2,504)
C      CALL IGrHardCopyOptions(3,35)
C      CALL IGrHardCopyOptions(4,76)
C      CALL IGrHardCopyOptions(5,1)
C      CALL IGrHardCopyOptions(9,7)
C      CALL IGrHardCopyOptions(14,0)
C      CALL IGrHardCopy(' ')
C      CALL SETSTANDARD
C     NOW READ ANOTHER COMMAND
                       END IF




      IF(JK_TAG.EQ.8.OR.JK_TAG.EQ.9) THEN
C     INITIALIZE THE BMP/COLBMP DRIVER
      PRINT *, "BMP TEST"
C      CALL IGrHardCopySelect(1,6)
C      CALL IGrHardCopyOptions(1,778)
C      CALL IGrHardCopyOptions(2,583)
C      CALL IGrHardCopyOptions(3,0)
C      CALL IGrHardCopyOptions(4,0)
C      CALL IGrHardCopyOptions(9,1)
C      CALL IGrHardCopyOptions(14,0)
C      CALL IGrHardCopyOptions(23,4)
C      CALL IGrHardCopyOptions(26,1)
C      CALL SETSTANDARD
C      CALL IGrHardCopy(GRFILN)
C     NOW READ ANOTHER COMMAND
                       END IF


               GO TO 300
               END IF
C
C     "PLOT COLTYP" = E
C

      IF(STRINGER.EQ.'E') THEN
C     SETTING THE FOREGROUND COLOR
      COLPASS=II1
      IF (COLTRUE.NE.COLPASS) THEN
         PRINT *, "COLPASS CHANGED NEWVAL = ", COLPASS
         COLTRUE = COLPASS
      END IF
      !IF(COLPASS.EQ.0)  COLTRUE=208
      !IF(COLPASS.EQ.1)  COLTRUE=48
      !IF(COLPASS.EQ.2)  COLTRUE=176
      !IF(COLPASS.EQ.3)  COLTRUE=16
      !IF(COLPASS.EQ.4)  COLTRUE=112
      !IF(COLPASS.EQ.5)  COLTRUE=80
      !IF(COLPASS.EQ.6)  COLTRUE=144
      !IF(COLPASS.EQ.7)  COLTRUE=240
      !IF(COLPASS.EQ.8)  COLTRUE=224
      !IF(COLPASS.EQ.9)  COLTRUE=64
      !IF(COLPASS.EQ.10) COLTRUE=192
      !IF(COLPASS.EQ.11) COLTRUE=32
      !IF(COLPASS.EQ.12) COLTRUE=128
      !IF(COLPASS.EQ.13) COLTRUE=96
      !IF(COLPASS.EQ.14) COLTRUE=160
      !IF(COLPASS.EQ.15) COLTRUE=240

      IF(COLPASS.EQ.0)  color = rgb(255,255,255)
      IF(COLPASS.EQ.1)  color = rgb(255,255,0)
      IF(COLPASS.EQ.2)  color = rgb(255,0,255)
      IF(COLPASS.EQ.3)  color = rgb(195, 0, 0)
      IF(COLPASS.EQ.4)  color = rgb( 0,195,195)
      IF(COLPASS.EQ.5)  color = rgb( 0,195, 0)
      IF(COLPASS.EQ.6)  color = rgb( 0, 0,195)

      !IF(COLPASS.EQ.0)  color = rgb(0,0,0)
      !IF(COLPASS.EQ.1)  color = rgb(0,0,0)
      !IF(COLPASS.EQ.2)  color = rgb(0,0,0)
      !IF(COLPASS.EQ.3)  color = rgb(0, 0, 0)
      !IF(COLPASS.EQ.4)  color = rgb(0,0,0)
      !IF(COLPASS.EQ.5)  color = rgb(0,0,0)
      !IF(COLPASS.EQ.6)  color = rgb(0,0,0)
      IF(COLPASS.EQ.7)  COLTRUE=240
      IF(COLPASS.EQ.8)  COLTRUE=224
      IF(COLPASS.EQ.9)  COLTRUE=64
      IF(COLPASS.EQ.10) COLTRUE=192
      IF(COLPASS.EQ.11) COLTRUE=32
      IF(COLPASS.EQ.12) COLTRUE=128
      IF(COLPASS.EQ.13) COLTRUE=96
      IF(COLPASS.EQ.14) COLTRUE=160
      IF(COLPASS.EQ.15) color = rgb(64,64,64)

       !CALL IGrColourN(COLTRUE)
               GO TO 300
               END IF
      ! Code that was working
      IF(STRINGER.EQ.'EEEE') THEN
      IF(JK_TAG.EQ.13) GO TO 300
      IF(JK_TAG.EQ.23) GO TO 300
      IF(JK_TAG.EQ.1.OR.JK_TAG.EQ.3) GO TO 300
      IF(JK_TAG.EQ.2.OR.JK_TAG.EQ.7.OR.JK_TAG.EQ.9
     1.OR.JK_TAG.EQ.19.OR.JK_TAG.EQ.32) THEN
C      CALL IGRPALETTERGB(208,0,0,0)
C     SETTING THE FOREGROUND COLOR
      COLPASS=II1
      IF(COLPASS.EQ.0)  COLTRUE=208
      IF(COLPASS.EQ.1)  COLTRUE=48
      IF(COLPASS.EQ.2)  COLTRUE=176
      IF(COLPASS.EQ.3)  COLTRUE=16
      IF(COLPASS.EQ.4)  COLTRUE=112
      IF(COLPASS.EQ.5)  COLTRUE=80
      IF(COLPASS.EQ.6)  COLTRUE=144
      IF(COLPASS.EQ.7)  COLTRUE=208
      IF(COLPASS.EQ.8)  COLTRUE=224
      IF(COLPASS.EQ.9)  COLTRUE=64
      IF(COLPASS.EQ.10) COLTRUE=192
      IF(COLPASS.EQ.11) COLTRUE=32
      IF(COLPASS.EQ.12) COLTRUE=128
      IF(COLPASS.EQ.13) COLTRUE=96
      IF(COLPASS.EQ.14) COLTRUE=160
      IF(COLPASS.EQ.15) COLTRUE=208
C      CALL IGrColourN(COLTRUE)
               END IF
      IF(JK_TAG.EQ.4.OR.JK_TAG.EQ.34) THEN
C      CALL IGRPALETTERGB(208,0,0,0)
C     SETTING THE FOREGROUND COLOR
      COLPASS=II1
      IF(COLPASS.EQ.0)  COLTRUE=208
      IF(COLPASS.EQ.1)  COLTRUE=48
      IF(COLPASS.EQ.2)  COLTRUE=176
      IF(COLPASS.EQ.3)  COLTRUE=16
      IF(COLPASS.EQ.4)  COLTRUE=112
      IF(COLPASS.EQ.5)  COLTRUE=80
      IF(COLPASS.EQ.6)  COLTRUE=144
      IF(COLPASS.EQ.7)  COLTRUE=208
      IF(COLPASS.EQ.8)  COLTRUE=224
      IF(COLPASS.EQ.9)  COLTRUE=64
      IF(COLPASS.EQ.10) COLTRUE=192
      IF(COLPASS.EQ.11) COLTRUE=32
      IF(COLPASS.EQ.12) COLTRUE=128
      IF(COLPASS.EQ.13) COLTRUE=96
      IF(COLPASS.EQ.14) COLTRUE=160
      IF(COLPASS.EQ.15) COLTRUE=208
C      CALL IGrColourN(COLTRUE)
               END IF
      IF(JK_TAG.EQ.14) THEN
C      CALL IGRPALETTERGB(208,0,0,0)
C     SETTING THE FOREGROUND COLOR
      COLPASS=II1
      IF(COLPASS.EQ.0)  COLTRUE=208
      IF(COLPASS.EQ.1)  COLTRUE=48
      IF(COLPASS.EQ.2)  COLTRUE=176
      IF(COLPASS.EQ.3)  COLTRUE=16
      IF(COLPASS.EQ.4)  COLTRUE=112
      IF(COLPASS.EQ.5)  COLTRUE=80
      IF(COLPASS.EQ.6)  COLTRUE=144
      IF(COLPASS.EQ.7)  COLTRUE=208
      IF(COLPASS.EQ.8)  COLTRUE=224
      IF(COLPASS.EQ.9)  COLTRUE=64
      IF(COLPASS.EQ.10) COLTRUE=192
      IF(COLPASS.EQ.11) COLTRUE=32
      IF(COLPASS.EQ.12) COLTRUE=128
      IF(COLPASS.EQ.13) COLTRUE=96
      IF(COLPASS.EQ.14) COLTRUE=160
      IF(COLPASS.EQ.15) COLTRUE=208
C      CALL IGrColourN(COLTRUE)
               END IF
      IF(JK_TAG.EQ.24) THEN
C      CALL IGRPALETTERGB(208,0,0,0)
C     SETTING THE FOREGROUND COLOR
      COLPASS=II1
      IF(COLPASS.EQ.0)  COLTRUE=208
      IF(COLPASS.EQ.1)  COLTRUE=48
      IF(COLPASS.EQ.2)  COLTRUE=176
      IF(COLPASS.EQ.3)  COLTRUE=16
      IF(COLPASS.EQ.4)  COLTRUE=112
      IF(COLPASS.EQ.5)  COLTRUE=80
      IF(COLPASS.EQ.6)  COLTRUE=144
      IF(COLPASS.EQ.7)  COLTRUE=208
      IF(COLPASS.EQ.8)  COLTRUE=224
      IF(COLPASS.EQ.9)  COLTRUE=64
      IF(COLPASS.EQ.10) COLTRUE=192
      IF(COLPASS.EQ.11) COLTRUE=32
      IF(COLPASS.EQ.12) COLTRUE=128
      IF(COLPASS.EQ.13) COLTRUE=96
      IF(COLPASS.EQ.14) COLTRUE=160
      IF(COLPASS.EQ.15) COLTRUE=208
C      CALL IGrColourN(COLTRUE)
               END IF
      IF(JK_TAG.EQ.6) THEN
C     SET BACKGROUND COLOR TO WHITE
C      CALL IGrPaletteRGB(0,255,255,255)
C     SET 208 COLOR TO BLACK
C      CALL IGRPALETTERGB(208,0,0,0)
C     DEFINE DARK GREY AS BLACK
C     SET ALL OTHER COLORS TO BLACK
      COLPASS=II1
      IF(COLPASS.EQ.0)  COLTRUE=208
      IF(COLPASS.EQ.1)  COLTRUE=208
      IF(COLPASS.EQ.2)  COLTRUE=208
      IF(COLPASS.EQ.3)  COLTRUE=208
      IF(COLPASS.EQ.4)  COLTRUE=208
      IF(COLPASS.EQ.5)  COLTRUE=208
      IF(COLPASS.EQ.6)  COLTRUE=208
      IF(COLPASS.EQ.7)  COLTRUE=208
      IF(COLPASS.EQ.8)  COLTRUE=208
      IF(COLPASS.EQ.9)  COLTRUE=208
      IF(COLPASS.EQ.10) COLTRUE=208
      IF(COLPASS.EQ.11) COLTRUE=208
      IF(COLPASS.EQ.12) COLTRUE=208
      IF(COLPASS.EQ.13) COLTRUE=208
      IF(COLPASS.EQ.14) COLTRUE=208
      IF(COLPASS.EQ.15) COLTRUE=208
C      CALL IGrColourN(COLTRUE)
               END IF
      IF(JK_TAG.EQ.8.OR.JK_TAG.EQ.18.OR.JK_TAG.EQ.31) THEN
C     SET BACKGROUND COLOR TO WHITE
C      CALL IGRPALETTERGB(0,255,255,255)
C     SET 208 COLOR TO BLACK
C      CALL IGrPaletteRGB(208,0,0,0)
C     DEFINE DARK GREY AS BLACK
C     SET ALL OTHER COLORS TO BLACK
      COLPASS=II1
      IF(COLPASS.EQ.0)  COLTRUE=208
      IF(COLPASS.EQ.1)  COLTRUE=208
      IF(COLPASS.EQ.2)  COLTRUE=208
      IF(COLPASS.EQ.3)  COLTRUE=208
      IF(COLPASS.EQ.4)  COLTRUE=208
      IF(COLPASS.EQ.5)  COLTRUE=208
      IF(COLPASS.EQ.6)  COLTRUE=208
      IF(COLPASS.EQ.7)  COLTRUE=208
      IF(COLPASS.EQ.8)  COLTRUE=208
      IF(COLPASS.EQ.9)  COLTRUE=208
      IF(COLPASS.EQ.10) COLTRUE=208
      IF(COLPASS.EQ.11) COLTRUE=208
      IF(COLPASS.EQ.12) COLTRUE=208
      IF(COLPASS.EQ.13) COLTRUE=208
      IF(COLPASS.EQ.14) COLTRUE=208
      IF(COLPASS.EQ.15) COLTRUE=208
C      CALL IGrColourN(COLTRUE)
               END IF
               GO TO 300
               END IF
C
C
C     "PLOT SETCHARACTERASPECT" = F
C
      IF(STRINGER.EQ.'F') THEN
C     SETTING THE CHARACTER ASPECT
      J=J+1
      READ(NEUTARRAY(J),1002) RRR1,RRR2
 1002 FORMAT(E15.7,E15.7,11X)
      JJ_X=RRR1
      JJ_Y=RRR2
C     NOW READ ANOTHER COMMAND
               GO TO 300
               END IF
C
C     "PLOT SETPAL" = G
C
      IF(STRINGER.EQ.'G') THEN
      IF(JK_TAG.EQ.1.OR.JK_TAG.EQ.3) GO TO 300
      IF(JK_TAG.EQ.13) GO TO 300
      IF(JK_TAG.EQ.23) GO TO 300
      IF(JK_TAG.EQ.6) GO TO 300
      IF(JK_TAG.EQ.8) GO TO 300
      IF(JK_TAG.EQ.18) GO TO 300
      IF(JK_TAG.EQ.31) GO TO 300
      IF(JK_TAG.EQ.4.OR.JK_TAG.EQ.34) THEN
C     SET BACKGROUND COLOR TO WHITE
C      CALL IGrPaletteRGB(0,255,255,255)
C     SET 208 COLOR TO BLACK
C      CALL IGRPALETTERGB(208,0,0,0)
               END IF
      IF(JK_TAG.EQ.14) THEN
C     SET BACKGROUND COLOR TO WHITE
C      CALL IGrPaletteRGB(0,255,255,255)
C     SET 208 COLOR TO BLACK
C      CALL IGRPALETTERGB(208,0,0,0)
               END IF
      IF(JK_TAG.EQ.24) THEN
C     SET BACKGROUND COLOR TO WHITE
C      CALL IGrPaletteRGB(0,255,255,255)
C     SET 208 COLOR TO BLACK
C      CALL IGRPALETTERGB(208,0,0,0)
               END IF
      IF(JK_TAG.EQ.7) THEN
C     SET BACKGROUND COLOR TO WHITE
C      CALL IGrPaletteRGB(0,255,255,255)
C     SET 208 COLOR TO BLACK
C      CALL IGRPALETTERGB(208,0,0,0)
               END IF
      IF(JK_TAG.EQ.9) THEN
C     SET BACKGROUND COLOR TO WHITE
C      CALL IGrPaletteRGB(0,255,255,255)
C     SET 208 COLOR TO BLACK
C      CALL IGRPALETTERGB(208,0,0,0)
               END IF
      IF(JK_TAG.EQ.19) THEN
C     SET BACKGROUND COLOR TO WHITE
C      CALL IGrPaletteRGB(0,255,255,255)
C     SET 208 COLOR TO BLACK
C      CALL IGRPALETTERGB(208,0,0,0)
               END IF
      IF(JK_TAG.EQ.32) THEN
C     SET BACKGROUND COLOR TO WHITE
C      CALL IGrPaletteRGB(0,255,255,255)
C     SET 208 COLOR TO BLACK
C      CALL IGRPALETTERGB(208,0,0,0)
               END IF
               GO TO 300
               END IF
C
C     "PLOT MARKER" = C
C
      IF(STRINGER.EQ.'C') THEN
C     PLOTTING A SYMBOL
C      CALL IGrMarker(REAL(II3),REAL(I4),II1)
C      CALL IGrCharSize(1.0,1.0)
C     NOW READ ANOTHER COMMAND
               GO TO 300
               END IF
C
C     "PLOT SETFONT" = H
C
      IF(STRINGER.EQ.'H') THEN
C     CHANGING FONTS
      CHARSTYPE=II1
C     NOW READ ANOTHER COMMAND
               GO TO 300
               END IF
C
C     "PLOT JUSTIFYSTRING" = D
C
      IF(STRINGER.EQ.'D') THEN

C     PLOTTING A STRING
                   J=J+1
 1003 FORMAT(A20,22X)
      READ(NEUTARRAY(J),1003)C1A
                   J=J+1
      READ(NEUTARRAY(J),1003)C1B
                   J=J+1
      READ(NEUTARRAY(J),1003)C1C
                   J=J+1
      READ(NEUTARRAY(J),1003)C1D
      AB='                    '
      C1=AB//AB//AB//AB
      IF(II6.LE.20) THEN
      C1(1:II6)=C1A(1:II6)
          END IF
      IF(II6.GT.20.AND.II6.LE.40) THEN
      C1(1:II6)=C1A(1:20)//C1B(1:II6-20)
          END IF
      IF(II6.GT.40.AND.II6.LE.60) THEN
      C1(1:II6)=C1A(1:20)//C1B(1:20)//C1C(1:II6-40)
          END IF
      IF(II6.GT.60.AND.II6.LE.80) THEN
      C1(1:II6)=C1A(1:20)//C1B(1:20)//C1C(1:20)//C1D(1:II6-60)
          END IF
C     IF(CHARSTYPE.EQ.1) CALL SETSTANDARD
C      IF(CHARSTYPE.EQ.2) CALL SETSYMBOL
      IA=0.0
      IB=35.0
C      CALL IGrCharRotate(REAL(II3))
C      CALL
C     1IGrCharSize((REAL(II4)*0.392*JJ_X),(REAL(II4)*0.363*JJ_Y))
C      CALL IGrCharRotate(REAL(II3))
C      IF(II3.EQ.0)
C     1CALL
C     2IGrCharSize((REAL(II4)*0.392*JJ_X),(REAL(II4)*0.30*JJ_Y))
C      IF(II3.EQ.90)
C     1CALL
C     2IGrCharSize((REAL(II4)*0.2*JJ_X),(REAL(II4)*0.363*JJ_Y))
      IF(II5.EQ.2) THEN
                   DO I=1,80
        IF(C1(1:1).EQ.' ') THEN
               C1(1:80)=C1(2:80)//' '
                   ELSE
               GO TO 88
                   END IF
                   END DO
 88                CONTINUE
                   JIMLEN=0
                   DO I=80,1,-1
        IF(C1(I:I).NE.' ') THEN
                   JIMLEN=I
                   GO TO 89
                   END IF
                   END DO
 89                CONTINUE
      IF(JIMLEN.EQ.1)   CC1=C1(1:1)
      IF(JIMLEN.EQ.2)   CC2=C1(1:2)
      IF(JIMLEN.EQ.3)   CC3=C1(1:3)
      IF(JIMLEN.EQ.4)   CC4=C1(1:4)
      IF(JIMLEN.EQ.5)   CC5=C1(1:5)
      IF(JIMLEN.EQ.6)   CC6=C1(1:6)
      IF(JIMLEN.EQ.7)   CC7=C1(1:7)
      IF(JIMLEN.EQ.8)   CC8=C1(1:8)
      IF(JIMLEN.EQ.9)   CC9=C1(1:9)
      IF(JIMLEN.EQ.10) CC10=C1(1:10)
      IF(JIMLEN.EQ.11) CC11=C1(1:11)
      IF(JIMLEN.EQ.12) CC12=C1(1:12)
      IF(JIMLEN.EQ.13) CC13=C1(1:13)
      IF(JIMLEN.EQ.14) CC14=C1(1:14)
      IF(JIMLEN.EQ.15) CC15=C1(1:15)
      IF(JIMLEN.EQ.16) CC16=C1(1:16)
      IF(JIMLEN.EQ.17) CC17=C1(1:17)
      IF(JIMLEN.EQ.18) CC18=C1(1:18)
      IF(JIMLEN.EQ.19) CC19=C1(1:19)
      IF(JIMLEN.EQ.20) CC20=C1(1:20)
      IF(JIMLEN.EQ.21) CC21=C1(1:21)
      IF(JIMLEN.EQ.22) CC22=C1(1:22)
      IF(JIMLEN.EQ.23) CC23=C1(1:23)
      IF(JIMLEN.EQ.24) CC24=C1(1:24)
      IF(JIMLEN.EQ.25) CC25=C1(1:25)
      IF(JIMLEN.EQ.26) CC26=C1(1:26)
      IF(JIMLEN.EQ.27) CC27=C1(1:27)
      IF(JIMLEN.EQ.28) CC28=C1(1:28)
      IF(JIMLEN.EQ.29) CC29=C1(1:29)
      IF(JIMLEN.EQ.30) CC30=C1(1:30)
      IF(JIMLEN.EQ.31) CC31=C1(1:31)
      IF(JIMLEN.EQ.32) CC32=C1(1:32)
      IF(JIMLEN.EQ.33) CC33=C1(1:33)
      IF(JIMLEN.EQ.34) CC34=C1(1:34)
      IF(JIMLEN.EQ.35) CC35=C1(1:35)
      IF(JIMLEN.EQ.36) CC36=C1(1:36)
      IF(JIMLEN.EQ.37) CC37=C1(1:37)
      IF(JIMLEN.EQ.38) CC38=C1(1:38)
      IF(JIMLEN.EQ.39) CC39=C1(1:39)
      IF(JIMLEN.EQ.40) CC40=C1(1:40)
                   END IF
C      IF(II5.EQ.2) THEN

C      CALL IGrCHARSIZE(1.0,1.0)
C     NOW READ ANOTHER COMMAND
               GO TO 300
               END IF
C
C     "PLOT PLOTTO" = I
C
      IF(STRINGER.EQ.'I') THEN
C       IF (II3.EQ.0) PRINT *, "PEN UP!"
        !PRINT *,REAL(II1)
         IF (MINII1.EQ.-1) MINII1 = REAL(II1)
         IF (MINII2.EQ.-1) MINII2 = REAL(II2)
         IF (MINII1.GT.REAL(II1)) MINII1 = REAL(II1)
         IF (MINII2.GT.REAL(II2)) MINII2 = REAL(II2)
         IF (MAXII1.LT.REAL(II1)) MAXII1 = REAL(II1)
         IF (MAXII2.LT.REAL(II2)) MAXII2 = REAL(II2)




       CALL JK_MoveTo(INT(II1)-1999,INT(II2)+171,II3,II4, animage,
     1color)
               GO TO 300
               END IF
C
C     "PLOT PLOTTOC" = J
C
      IF(STRINGER.EQ.'J') THEN

C      CALL JK_MoveTO(REAL(II1),REAL(II2),II3,II4,II5,II6,II7,II8)
               GO TO 300
               END IF
C
C     CAPFN_OPD CONTOUR PLOTTING
C
      IF(STRINGER.EQ.'K') THEN
      J=J+1
      READ(NEUTARRAY(J),2011) STRINGER,OPDPEAK,OPDPIT
 2011 FORMAT(A1,E15.7,E15.7,10X)
      NX=I1
      NY=I1
      ZSTEP=II2
      ALLOCATE(CON_ARRAY(1:NX,1:NY),STAT=ALLOERR)

                                DO II=1,NX
                                DO JJ=1,NY
      J=J+1
      READ(NEUTARRAY(J),1001) STRINGER,I1,I2,I3,I4,I5,I6,I7,I8
      CON_ARRAY(II,JJ)=I1
                                END DO
                                END DO
C      CALL DrawContour_OPD(NX,NY,ZSTEP,CON_ARRAY,JK_TAG,
C     1OPDPEAK,OPDPIT)
      DEALLOCATE(CON_ARRAY,STAT=ALLOERR)
               GO TO 300
               END IF
      IF(STRINGER.EQ.'M') THEN
      NX=I1
      NY=I1
      ZSTEP=II2
      ALLOCATE(CON_ARRAY(1:NX,1:NY),STAT=ALLOERR)

                                DO II=1,NX
                                DO JJ=1,NY
      J=J+1
      READ(NEUTARRAY(J),1001) STRINGER,I1,I2,I3,I4,I5,I6,I7,I8
      CON_ARRAY(II,JJ)=I1
                                END DO
                                END DO
C      CALL DrawContour_APD(NX,NY,ZSTEP,CON_ARRAY,JK_TAG)
      DEALLOCATE(CON_ARRAY,STAT=ALLOERR)
               GO TO 300
               END IF
C
C     "PLOT END" = B
      IF(J.EQ.NEUTTOTAL+1) READ(NEUTARRAY(J),1001) STRINGER
     1,I1,I2,I3,I4,I5,I6,I7,I8
      IF(J.EQ.NEUTTOTAL+1.OR.STRINGER(1:1).NE.'B') THEN
      STRINGER='B'
      I1=0
      I2=0
      I3=0
      I4=0
      I5=0
      I6=0
      I7=0
      I8=0
      PRINT *, "GRAOUT B STRINGER = ", STRINGER
      END IF
      IF(J.EQ.NEUTTOTAL+1.AND.STRINGER(1:1).EQ.'B') THEN
      PRINT *, "DEBUG"
C      CALL IGrHardCopy('S')
               RETURN
               END IF
      GO TO 300
 999           CONTINUE
       PRINT *, "MIN II1", MINII1
       PRINT *, "MIN II2", MINII2
       PRINT *, "MAX II1", MAXII1
       PRINT *, "MAX II2", MAXII2

       !open(unit=10, file='outputimage.ppm', status='unknown')

       !call output_ppm(10, animage)
       !call convertRGBtoPixBuf(animage)

       ! Doesn't work
       !! call rgbimage_write(this, )
       !! call write_ppm('outputimage.ppm', animage)
       !close(10)

       call free_img(animage)
C      CALL IGrHardCopy('S')
               RETURN

               END

      SUBROUTINE MY_SYSTEM2(ABLE,N)

      IMPLICIT NONE
      INTEGER N
      INCLUDE 'DATMAI.INC'
      CHARACTER*(*) ABLE
C       TEST SINCE ERROR ON TRIM AND LEN WITH IVF COMPILER, 1/4/07
C       write(outlyne,*) able(1:70)
C       CALL SHOWIT(1)
C       CALL MACPAUSE
C     ABLE=TRIM(ABLE)
C     N=LEN(ABLE)
C       write(outlyne,*) able(1:70),N
C       CALL SHOWIT(1)
C       CALL MACPAUSE
C      CALL IOSCOMMAND(ABLE(1:N),2)
      RETURN
      END


      SUBROUTINE JK_MOVETO(MY_IX,MY_IY,MY_IPEN,MY_LINESTYLE, animage,
     1 color)
      use RCImageBasic
      use RCImageIO
      use RCImagePrimitive
C      USE WINTERACTER
      IMPLICIT NONE
      REAL INKER,XINC,YINC
      type (rgbImage) animage
      type (rgb) color
      INTEGER MY_IX,MY_IY,MY_IPEN,MY_LINESTYLE,
     1MY_OLDIPEN
      REAL OX,OY,MY_OLDX,MY_OLDY,DELTADIST
      COMMON/MYLINESTUFF/OX,OY,MY_OLDX,MY_OLDY,MY_OLDIPEN
      REAL MY_DISTANCE,X,Y,OLDDIST
      REAL REMAIN,OREMAIN,MYMOD
      COMMON/HOWFAR/MY_DISTANCE,OLDDIST,REMAIN,OREMAIN
      REAL SLOPE
      INKER=2.0
C
      IF(MY_IPEN.EQ.0) THEN
C     USER HAS THE PEN UP
C     WE ARE JUST MOVING SOME PLACE SO RE-SET MY_DISTANCE TO ZERO

      MY_DISTANCE=0
C     NOW MAKE THE MOVE
C      CALL IGRMOVETO(MY_IX,MY_IY)
C     UPDATE OLD VALUES
      MY_OLDX=MY_IX
      MY_OLDY=MY_IY
      OX=MY_OLDX
      OY=MY_OLDY
      MY_OLDIPEN=MY_IPEN
      REMAIN=0.0
      OREMAIN=0.0
      MY_DISTANCE=0.0
      OLDDIST=0.0
                       RETURN
                       END IF
C
      IF(MY_IPEN.EQ.1) THEN
C     USER HAS THE PEN DOWN
      IF(MY_LINESTYLE.EQ.0) THEN
C     SIMPLE SOLID LINE (TYPE 0)
C      MY_OLDX=MY_IX
C      MY_OLDY=MY_IY

       call draw_line(animage, point(MY_IX,MY_IY),
     1 point(MY_OLDX, MY_OLDY), color)

      OX=MY_OLDX
      OY=MY_OLDY

      MY_OLDX = MY_IX
      MY_OLDY = MY_IY


      MY_DISTANCE=0.0
      OLDDIST=0.0
      OLDDIST=0
      REMAIN=0.0
      OREMAIN=0.0
      !PRINT *, "DRAWING LINE"


      !OX=MY_OLDX
      !OY=MY_OLDY
      !MY_DISTANCE=0.0
      !OLDDIST=0.0
      !OLDDIST=0
      !REMAIN=0.0
      !OREMAIN=0.0
      !PRINT *, "DRAWING LINE"
       !call draw_line(animage, point(MY_OLDX,MY_OLDY),
C     1 point(MY_IX, MY_IY), color)

C*****************************************************************************
C     UPDATE OLD VALUES
C      MY_IX=MY_OLDX
C      MY_IY=MY_OLDY

C      MY_OLDIPEN=MY_IPEN

C      MY_OLDX=MY_IX
C      MY_OLDY=MY_IY
       MY_OLDIPEN=MY_IPEN
C      CALL IGRLINETO(MY_IX,MY_IY)


                       END IF
      IF(MY_LINESTYLE.GT.0) THEN
        PRINT *, "MY_LINESTYLE = ", MY_LINESTYLE
                       END IF
                       END IF

                       END

      SUBROUTINE RUN_WDRAW
C     THIS IS THE DRIVER ROUTINE FOR SENDING GRAPHICS TO
C     A GRAPHIC WINDOW
C      USE WINTERACTER
      use handlers

      IMPLICIT NONE
      !CALL GRAOUTPRT(8,"VIECO")
       !PRINT *, "RUN_WDRAW"
      ! CALL RUN_WPLOT('08'//'BMP.BMP') !CEELINE=JK_TAG//(GRFILN(1:12))
      INCLUDE 'DATMAI.INC'


      ! HACK TO USE GRAOUT INSTEAD OF DRAW
      !INPUT = "GRAOUT BMP"
      !CALL PROCES

      !PRINT *, "ABOUT TO CALL WDRAWOPTICAL SYSTEM FROM RUN_WDRAW"
      !PRINT *, "BEFORE my_window is ", my_window
      !call WDRAWOPTICALSYSTEM


      LOGICAL EXISD
      !INCLUDE 'DATMAI.INC'
      CALL WDRAW
      RETURN
      END
       SUBROUTINE WDRAW
       USE GLOBALS
C       USE WINTERACTER
        use kdp_interfaces
       IMPLICIT NONE
       LOGICAL FIRST
       INTEGER ISKEY
       INTEGER NEUTTOTAL

       FIRST=.TRUE.
       ISKEY=-999
       READ(NEUTARRAY(1),1000) NEUTTOTAL
 1000  FORMAT(I9,32X)
       IF(NEUTTOTAL.EQ.0) GO TO 10

      call WDRAWOPTICALSYSTEM

 10   CONTINUE
                        RETURN
                        END

      SUBROUTINE DRAW(ITYPER,FIRST,ISKEY)
      USE GLOBALS
C      USE WINTERACTER
      use RCImageBasic
      use RCImageIO
      use RCImagePrimitive

      IMPLICIT NONE
      type(rgbimage) :: animage
      type(rgb) :: color
      LOGICAL FIRST
      INTEGER CON_ARRAY,NX,NY,ZSTEP,ALLOERR
      REAL OPDPEAK,OPDPIT
      DIMENSION CON_ARRAY(:,:)
      ALLOCATABLE :: CON_ARRAY
      CHARACTER AB*80,STRINGER*1,C1A*20,C1B*20,C1C*20,C1D*20
      CHARACTER C1*80
      CHARACTER CC1*1
      CHARACTER CC2*2
      CHARACTER CC3*3
      CHARACTER CC4*4
      CHARACTER CC5*5
      CHARACTER CC6*6
      CHARACTER CC7*7
      CHARACTER CC8*8
      CHARACTER CC9*9
      CHARACTER CC10*10
      CHARACTER CC11*11
      CHARACTER CC12*12
      CHARACTER CC13*13
      CHARACTER CC14*14
      CHARACTER CC15*15
      CHARACTER CC16*16
      CHARACTER CC17*17
      CHARACTER CC18*18
      CHARACTER CC19*19
      CHARACTER CC20*20
      CHARACTER CC21*21
      CHARACTER CC22*22
      CHARACTER CC23*23
      CHARACTER CC24*24
      CHARACTER CC25*25
      CHARACTER CC26*26
      CHARACTER CC27*27
      CHARACTER CC28*28
      CHARACTER CC29*29
      CHARACTER CC30*30
      CHARACTER CC31*31
      CHARACTER CC32*32
      CHARACTER CC33*33
      CHARACTER CC34*34
      CHARACTER CC35*35
      CHARACTER CC36*36
      CHARACTER CC37*37
      CHARACTER CC38*38
      CHARACTER CC39*39
      CHARACTER CC40*40
      INTEGER I,I1,I2,I3,I4,I5,I6,I7,I8,JIMLEN
      INTEGER ISKEY,II1,II2,II3,II4,II5,II6,II7,II8
     1,COLPASS,COLTRUE,CHARSTYPE,ITYPER
      INTEGER J,II,JJ
      REAL CL1,CL2,CL3,CL4
      COMMON/OLDCLIP/CL1,CL2,CL3,CL4
      REAL IA,IB,RRR1,RRR2
      COMMON/TEXTCOM/CHARSTYPE
      COMMON/COLCOM/COLPASS,COLTRUE
      REAL JJ_X,JJ_Y
      COMMON/ASPECTER/JJ_X,JJ_Y
      INCLUDE 'DATMAI.INC'
      INCLUDE 'DATHGR.INC'
C     INITIALIZE CHARACTER ASPECT RATIO
      JJ_X=1.0
      JJ_Y=1.0

      OUTLYNE = "DRAW ROUTINE"
      CALL SHOWIT(19)

      call alloc_img(animage, 7400, 5652)
      call fill_img(animage, rgb(255,255,255))

                       J=1
      READ(NEUTARRAY(1),1000) NEUTTOTAL
 1000 FORMAT(I9,32X)
 300                   J=J+1
      READ(NEUTARRAY(J),2000) STRINGER,I1,I2,I3,I4,I5,I6,I7,I8
 2000 FORMAT(A1,I5,I5,I5,I5,I5,I5,I5,I5)
      II1=(I1)
      II2=(I2)
      II3=(I3)
      II4=(I4)
      II5=(I5)
      II6=(I6)
      II7=(I7)
      II8=(I8)
C
C     "PLOT NEW" STRINGER = A
C
      IF(STRINGER.EQ.'A') THEN
C     INITIALIZE THE DRAW SCREEN
      !CALL NEWDRAWSCREEN
C
C     DEFINE DARK GREY AS BLACK
C     THIS LETS COLOR 0 BE RE-DEFINED AS ANY BACKGROUND COLOR DESIRED
C      CALL IGRPALETTERGB(240,0,0,0)
C     DEFINE COLOR 208 AS WHITE
C     THIS LETS COLOR 0 BE RE-DEFINED AS ANY BACKGROUND COLOR DESIRED
      !CALL IGRPALETTERGB(208,255,255,255)
C     NOW READ ANOTHER COMMAND
               GO TO 300
               END IF
C
C     "PLOT COLTYP"
C
      IF(STRINGER.EQ.'E') THEN
C     SETTING THE FOREGROUND COLOR
      COLPASS=II1
      IF(COLPASS.EQ.0)  COLTRUE=208
      IF(COLPASS.EQ.1)  COLTRUE=48
      IF(COLPASS.EQ.2)  COLTRUE=176
      IF(COLPASS.EQ.3)  COLTRUE=16
      IF(COLPASS.EQ.4)  COLTRUE=112
      IF(COLPASS.EQ.5)  COLTRUE=80
      IF(COLPASS.EQ.6)  COLTRUE=144
      IF(COLPASS.EQ.7)  COLTRUE=240
      IF(COLPASS.EQ.8)  COLTRUE=224
      IF(COLPASS.EQ.9)  COLTRUE=64
      IF(COLPASS.EQ.10) COLTRUE=192
      IF(COLPASS.EQ.11) COLTRUE=32
      IF(COLPASS.EQ.12) COLTRUE=128
      IF(COLPASS.EQ.13) COLTRUE=96
      IF(COLPASS.EQ.14) COLTRUE=160
      IF(COLPASS.EQ.15) COLTRUE=240
      !CALL IGrColourN(COLTRUE)
               GO TO 300
               END IF
C
C
C     "PLOT SETCHARACTERASPECT" = F
C
      IF(STRINGER.EQ.'F') THEN
C     SETTING THE CHARACTER ASPECT
      J=J+1
 3000 FORMAT(E15.7,E15.7,11X)
      READ(NEUTARRAY(J),3000) RRR1,RRR2
      JJ_X=RRR1
      JJ_Y=RRR2
C     NOW READ ANOTHER COMMAND
               GO TO 300
               END IF
C
C     "PLOT SETPAL" = G
C
      IF(STRINGER.EQ.'G') THEN
C     SETTING THE BACKGROUND COLOR TO A NEW VALUE
C     FORCES A SCREEN CLEAR AND A PLOT NEW EFFECT
      !IF(II1.EQ.0)  CALL IGrPaletteRGB(0,255,255,255)
      !IF(II1.EQ.1)  CALL IGrPaletteRGB(0,255,255,000)
      !IF(II1.EQ.2)  CALL IGrPaletteRGB(0,255,000,255)
      !IF(II1.EQ.3)  CALL IGrPaletteRGB(0,255,000,000)
      !IF(II1.EQ.4)  CALL IGrPaletteRGB(0,000,255,255)
      !IF(II1.EQ.5)  CALL IGrPaletteRGB(0,000,255,000)
      !IF(II1.EQ.6)  CALL IGrPaletteRGB(0,000,000,255)
      !IF(II1.EQ.7)  CALL IGrPaletteRGB(0,000,000,000)
      !IF(II1.EQ.8)  CALL IGrPaletteRGB(0,191,191,191)
      !IF(II1.EQ.9)  CALL IGrPaletteRGB(0,191,191,000)
      !IF(II1.EQ.10) CALL IGrPaletteRGB(0,191,000,191)
      !IF(II1.EQ.11) CALL IGrPaletteRGB(0,191,000,000)
      !IF(II1.EQ.12) CALL IGrPaletteRGB(0,000,191,191)
      !IF(II1.EQ.13) CALL IGrPaletteRGB(0,000,191,000)
      !IF(II1.EQ.14) CALL IGrPaletteRGB(0,000,000,191)
      !IF(II1.EQ.15) CALL IGrPaletteRGB(0,000,000,000)
C     DEFINE DARK GREY AS BLACK
      !CALL IGRPALETTERGB(240,0,0,0)
      !CALL IGrViewport(-510.0,-510.0,10510.0,7510.0)
      !CALL IGrAreaClear
C     NOW READ ANOTHER COMMAND
               GO TO 300
               END IF
C
C     "PLOT MARKER" = C
C
      IF(STRINGER.EQ.'C') THEN
C     PLOTTING A SYMBOL
      !CALL IGrMarker(REAL(II3),REAL(II4),II1)
      !CALL IGrCharSize(1.0,1.0)
C     NOW READ ANOTHER COMMAND
               GO TO 300
               END IF
C
C     "PLOT SETFONT" = H
C
      IF(STRINGER.EQ.'H') THEN
C     CHANGING FONTS
      CHARSTYPE=II1
C     NOW READ ANOTHER COMMAND
               GO TO 300
               END IF
C
C     "PLOT JUSTIFYSTRING" = D
C
      IF(STRINGER.EQ.'D') THEN
C     PLOTTING A STRING
                   J=J+1
 4000 FORMAT(A20,22X)
      READ(NEUTARRAY(J),4000) C1A
                   J=J+1
      READ(NEUTARRAY(J),4000) C1B
                   J=J+1
      READ(NEUTARRAY(J),4000) C1C
                   J=J+1
      READ(NEUTARRAY(J),4000) C1D
      AB='                    '
      C1=AB//AB//AB//AB
      IF(II6.LE.20) THEN
      C1(1:II6)=C1A(1:II6)
          END IF
      IF(II6.GT.20.AND.II6.LE.40) THEN
      C1(1:II6)=C1A(1:20)//C1B(1:II6-20)
          END IF
      IF(II6.GT.40.AND.II6.LE.60) THEN
      C1(1:II6)=C1A(1:20)//C1B(1:20)//C1C(1:II6-40)
          END IF
      IF(II6.GT.60.AND.II6.LE.80) THEN
      C1(1:II6)=C1A(1:20)//C1B(1:20)//C1C(1:20)//C1D(1:II6-60)
          END IF
      !IF(CHARSTYPE.EQ.1) CALL SETSTANDARD
      !IF(CHARSTYPE.EQ.2) CALL SETSYMBOL
      IA=0.0
      IB=35.0
!      CALL
!     1IGrCharSize((REAL(II4)*0.392*JJ_X),(REAL(II4)*0.363*JJ_Y))
      !CALL IGrCharRotate(REAL(II3))
      IF(II5.EQ.2) THEN
                   DO I=1,80
        IF(C1(1:1).EQ.' ') THEN
               C1(1:80)=C1(2:80)//' '
                   ELSE
               GO TO 88
                   END IF
                   END DO
 88                CONTINUE
                   JIMLEN=0
                   DO I=80,1,-1
        IF(C1(I:I).NE.' ') THEN
                   JIMLEN=I
                   GO TO 99
                   END IF
                   END DO
 99                CONTINUE
      IF(JIMLEN.EQ.1)   CC1=C1(1:1)
      IF(JIMLEN.EQ.2)   CC2=C1(1:2)
      IF(JIMLEN.EQ.3)   CC3=C1(1:3)
      IF(JIMLEN.EQ.4)   CC4=C1(1:4)
      IF(JIMLEN.EQ.5)   CC5=C1(1:5)
      IF(JIMLEN.EQ.6)   CC6=C1(1:6)
      IF(JIMLEN.EQ.7)   CC7=C1(1:7)
      IF(JIMLEN.EQ.8)   CC8=C1(1:8)
      IF(JIMLEN.EQ.9)   CC9=C1(1:9)
      IF(JIMLEN.EQ.10) CC10=C1(1:10)
      IF(JIMLEN.EQ.11) CC11=C1(1:11)
      IF(JIMLEN.EQ.12) CC12=C1(1:12)
      IF(JIMLEN.EQ.13) CC13=C1(1:13)
      IF(JIMLEN.EQ.14) CC14=C1(1:14)
      IF(JIMLEN.EQ.15) CC15=C1(1:15)
      IF(JIMLEN.EQ.16) CC16=C1(1:16)
      IF(JIMLEN.EQ.17) CC17=C1(1:17)
      IF(JIMLEN.EQ.18) CC18=C1(1:18)
      IF(JIMLEN.EQ.19) CC19=C1(1:19)
      IF(JIMLEN.EQ.20) CC20=C1(1:20)
      IF(JIMLEN.EQ.21) CC21=C1(1:21)
      IF(JIMLEN.EQ.22) CC22=C1(1:22)
      IF(JIMLEN.EQ.23) CC23=C1(1:23)
      IF(JIMLEN.EQ.24) CC24=C1(1:24)
      IF(JIMLEN.EQ.25) CC25=C1(1:25)
      IF(JIMLEN.EQ.26) CC26=C1(1:26)
      IF(JIMLEN.EQ.27) CC27=C1(1:27)
      IF(JIMLEN.EQ.28) CC28=C1(1:28)
      IF(JIMLEN.EQ.29) CC29=C1(1:29)
      IF(JIMLEN.EQ.30) CC30=C1(1:30)
      IF(JIMLEN.EQ.31) CC31=C1(1:31)
      IF(JIMLEN.EQ.32) CC32=C1(1:32)
      IF(JIMLEN.EQ.33) CC33=C1(1:33)
      IF(JIMLEN.EQ.34) CC34=C1(1:34)
      IF(JIMLEN.EQ.35) CC35=C1(1:35)
      IF(JIMLEN.EQ.36) CC36=C1(1:36)
      IF(JIMLEN.EQ.37) CC37=C1(1:37)
      IF(JIMLEN.EQ.38) CC38=C1(1:38)
      IF(JIMLEN.EQ.39) CC39=C1(1:39)
      IF(JIMLEN.EQ.40) CC40=C1(1:40)
                   END IF
    !  IF(II5.EQ.2) THEN
      !CALL IGrCharJustify('center')
    !  IF(JIMLEN.EQ.1)
    ! 1CALL IGrCharOut(REAL(II1)+IA,REAL(II2)+IB,CC1)
    !  IF(JIMLEN.EQ.2)
    ! 1CALL IGrCharOut(REAL(II1)+IA,REAL(II2)+IB,CC2)
    !  IF(JIMLEN.EQ.3)
    ! 1CALL IGrCharOut(REAL(II1)+IA,REAL(II2)+IB,CC3)
    !  IF(JIMLEN.EQ.4)
    ! 1CALL IGrCharOut(REAL(II1)+IA,REAL(II2)+IB,CC4)
    !  IF(JIMLEN.EQ.5)
    ! 1CALL IGrCharOut(REAL(II1)+IA,REAL(II2)+IB,CC5)
    !  IF(JIMLEN.EQ.6)
    ! 1CALL IGrCharOut(REAL(II1)+IA,REAL(II2)+IB,CC6)
    !  IF(JIMLEN.EQ.7)
    ! 1CALL IGrCharOut(REAL(II1)+IA,REAL(II2)+IB,CC7)
    !  IF(JIMLEN.EQ.8)
    ! 1CALL IGrCharOut(REAL(II1)+IA,REAL(II2)+IB,CC8)
    !  IF(JIMLEN.EQ.9)
    ! 1CALL IGrCharOut(REAL(II1)+IA,REAL(II2)+IB,CC9)
    !  IF(JIMLEN.EQ.10)
    ! 1CALL IGrCharOut(REAL(II1)+IA,REAL(II2)+IB,CC10)
    !  IF(JIMLEN.EQ.11)
    ! 1CALL IGrCharOut(REAL(II1)+IA,REAL(II2)+IB,CC11)
    !  IF(JIMLEN.EQ.12)
    ! 1CALL IGrCharOut(REAL(II1)+IA,REAL(II2)+IB,CC12)
    !  IF(JIMLEN.EQ.13)
    ! 1CALL IGrCharOut(REAL(II1)+IA,REAL(II2)+IB,CC13)
    !  IF(JIMLEN.EQ.14)
    ! 1CALL IGrCharOut(REAL(II1)+IA,REAL(II2)+IB,CC14)
    !  IF(JIMLEN.EQ.15)
    ! 1CALL IGrCharOut(REAL(II1)+IA,REAL(II2)+IB,CC15)
    !  IF(JIMLEN.EQ.16)
    ! 1CALL IGrCharOut(REAL(II1)+IA,REAL(II2)+IB,CC16)
    !  IF(JIMLEN.EQ.17)
    ! 1CALL IGrCharOut(REAL(II1)+IA,REAL(II2)+IB,CC17)
    !  IF(JIMLEN.EQ.18)
    ! 1CALL IGrCharOut(REAL(II1)+IA,REAL(II2)+IB,CC18)
    !  IF(JIMLEN.EQ.19)
    ! 1CALL IGrCharOut(REAL(II1)+IA,REAL(II2)+IB,CC19)
    !  IF(JIMLEN.EQ.20)
    ! 1CALL IGrCharOut(REAL(II1)+IA,REAL(II2)+IB,CC20)
    !  IF(JIMLEN.EQ.21)
    ! 1CALL IGrCharOut(REAL(II1)+IA,REAL(II2)+IB,CC21)
    !  IF(JIMLEN.EQ.22)
    ! 1CALL IGrCharOut(REAL(II1)+IA,REAL(II2)+IB,CC22)
    !  IF(JIMLEN.EQ.23)
    ! 1CALL IGrCharOut(REAL(II1)+IA,REAL(II2)+IB,CC23)
    !  IF(JIMLEN.EQ.24)
    ! 1CALL IGrCharOut(REAL(II1)+IA,REAL(II2)+IB,CC24)
    !  IF(JIMLEN.EQ.25)
    ! 1CALL IGrCharOut(REAL(II1)+IA,REAL(II2)+IB,CC25)
    !  IF(JIMLEN.EQ.26)
    ! 1CALL IGrCharOut(REAL(II1)+IA,REAL(II2)+IB,CC26)
    !  IF(JIMLEN.EQ.27)
    ! 1CALL IGrCharOut(REAL(II1)+IA,REAL(II2)+IB,CC27)
    !  IF(JIMLEN.EQ.28)
    ! 1CALL IGrCharOut(REAL(II1)+IA,REAL(II2)+IB,CC28)
    !  IF(JIMLEN.EQ.29)
    ! 1CALL IGrCharOut(REAL(II1)+IA,REAL(II2)+IB,CC29)
    !  IF(JIMLEN.EQ.30)
    ! 1CALL IGrCharOut(REAL(II1)+IA,REAL(II2)+IB,CC30)
    !  IF(JIMLEN.EQ.31)
    ! 1CALL IGrCharOut(REAL(II1)+IA,REAL(II2)+IB,CC31)
    !  IF(JIMLEN.EQ.32)
    ! 1CALL IGrCharOut(REAL(II1)+IA,REAL(II2)+IB,CC32)
    !  IF(JIMLEN.EQ.33)
    ! 1CALL IGrCharOut(REAL(II1)+IA,REAL(II2)+IB,CC33)
    !  IF(JIMLEN.EQ.34)
    ! 1CALL IGrCharOut(REAL(II1)+IA,REAL(II2)+IB,CC34)
    !  IF(JIMLEN.EQ.35)
    ! 1CALL IGrCharOut(REAL(II1)+IA,REAL(II2)+IB,CC35)
    !  IF(JIMLEN.EQ.36)
    ! 1CALL IGrCharOut(REAL(II1)+IA,REAL(II2)+IB,CC36)
    !  IF(JIMLEN.EQ.37)
    ! 1CALL IGrCharOut(REAL(II1)+IA,REAL(II2)+IB,CC37)
    !  IF(JIMLEN.EQ.38)
    ! 1CALL IGrCharOut(REAL(II1)+IA,REAL(II2)+IB,CC38)
    !  IF(JIMLEN.EQ.39)
    ! 1CALL IGrCharOut(REAL(II1)+IA,REAL(II2)+IB,CC39)
    !  IF(JIMLEN.EQ.40)
    ! 1CALL IGrCharOut(REAL(II1)+IA,REAL(II2)+IB,CC40)
    !                   ELSE
    !  CALL IGrCharJustify('left')
    !  CALL IGrCharOut(REAL(II1)+IA,REAL(II2)+IB,C1)
    !                   END IF
    !  CALL IGrCHARSIZE(1.0,1.0)
C     NOW READ ANOTHER COMMAND
               GO TO 300
               END IF

C     "PLOT PLOTTO" = I
C
      color = rgb(0,0,0)
      IF(STRINGER.EQ.'I') THEN
      CALL JK_MoveTo(INT(II1),INT(II2),II3,II4, animage, color)
               GO TO 300
               END IF
C
C     "PLOT PLOTTOC" = J
C
      IF(STRINGER.EQ.'J') THEN

      !CALL JK_MoveToC(REAL(II1),REAL(II2),II3,II4,II5,II6,II7,II8)
               GO TO 300
               END IF
C
C     CAPFN_OPD CONTOUR PLOTTING
C
      IF(STRINGER.EQ.'K') THEN
      NX=I1
      NY=I1
      ZSTEP=II2
      ALLOCATE(CON_ARRAY(1:NX,1:NY),STAT=ALLOERR)
      J=J+1
      READ(NEUTARRAY(J),2011) STRINGER,OPDPEAK,OPDPIT
 2011 FORMAT(A1,E15.7,E15.7,10X)
                                DO II=1,NX
                                DO JJ=1,NY
      J=J+1
      READ(NEUTARRAY(J),2000) STRINGER,I1,I2,I3,I4,I5,I6,I7,I8
      CON_ARRAY(II,JJ)=I1
                                END DO
                                END DO
      !CALL DrawContour_OPD(NX,NY,ZSTEP,CON_ARRAY,OPDPEAK,OPDPIT)
      DEALLOCATE(CON_ARRAY,STAT=ALLOERR)
               GO TO 300
               END IF
      IF(STRINGER.EQ.'M') THEN
      NX=I1
      NY=I1
      ZSTEP=II2
      ALLOCATE(CON_ARRAY(1:NX,1:NY),STAT=ALLOERR)

                                DO II=1,NX
                                DO JJ=1,NY
      J=J+1
      READ(NEUTARRAY(J),2000) STRINGER,I1,I2,I3,I4,I5,I6,I7,I8
      CON_ARRAY(II,JJ)=I1
                                END DO
                                END DO
      !CALL DrawContour_APD(NX,NY,ZSTEP,CON_ARRAY)
      DEALLOCATE(CON_ARRAY,STAT=ALLOERR)
               GO TO 300
               END IF
C
C     "PLOT END" = B
       IF(STRINGER.EQ.'B'.AND.J.LT.NEUTTOTAL+1) GO TO 300
C
 8    CONTINUE
      IF(ISKEY.EQ.259.OR.ISKEY.EQ.260) ISKEY=-999
C      IF(J.EQ.NEUTTOTAL+1) THEN
      IF(STRINGER.EQ.'B'.OR.J.GE.NEUTTOTAL+1) THEN
      IF(ITYPER.EQ.2) RETURN
 5    CONTINUE !CALL MY_INFOINPUT(ISKEY)
      IF(ISKEY.EQ.259.AND..NOT.FIRST) GO TO 6
      IF(ISKEY.EQ.259.AND.FIRST) FIRST=.FALSE.
      IF(ISKEY.EQ.259.AND..NOT.FIRST) GO TO 6
      IF(ISKEY.EQ.260) THEN
                RETURN
                END IF
      IF(ISKEY.NE.259.AND.ISKEY.NE.260) GO TO 5
               END IF
               GO TO 7
 6    PRINT *, "GOTO 6" !CALL REDRAWSCREEN(FIRST,ISKEY)
               GO TO 8
 7             CONTINUE
               GO TO 300
       ! CLeanup
       !This is in the abandoned files for now.
       !call convertRGBtoPixBuf(animage)

       call free_img(animage)
               END
